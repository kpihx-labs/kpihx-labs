stages:
  - deploy
  - sync

variables:
  # Optimisation Docker pour √©viter les logs infinis
  DOCKER_DRIVER: overlay2

# --- JOB 1 : D√âPLOIEMENT SUR LE SERVEUR ---
deploy_homelab:
  stage: deploy
  tags:
    - homelab   # Cible ton runner sur le serveur
  only:
    - main
  script:
    - echo "üöÄ D√©marrage du d√©ploiement Django..."
    
    # 1. G√©n√©ration du fichier .env pour la PROD
    # On injecte les secrets d√©finis dans GitLab (Settings > CI/CD > Variables)
    - echo "DEBUG=False" > .env
    - echo "SECRET_KEY=$SECRET_KEY" >> .env
    # En prod, on autorise l'IP locale, le domaine public et le domaine local
    - echo "ALLOWED_HOSTS=localhost,127.0.0.1,kpihx-labs.com,www.kpihx-labs.com,portal.homelab,web" >> .env
    
    # Config Database
    - echo "DB_NAME=kpihx_db" >> .env
    - echo "DB_USER=admin" >> .env
    - echo "DB_PASS=$DB_PASS" >> .env
    - echo "DB_HOST=postgres" >> .env
    - echo "DB_PORT=5432" >> .env
    
    # Config Proxy (Vital pour le build √† l'X)
    # - echo "http_proxy=$PROXY_URL" >> .env
    # - echo "https_proxy=$PROXY_URL" >> .env

    # 2. Construction et Lancement
    # --remove-orphans nettoie les vieux conteneurs
    - docker compose up -d --build --remove-orphans
    
    # 3. Op√©rations Post-D√©marrage (Sp√©cifique Django)
    
    # A. MIGRATIONS BDD
    # On demande au conteneur 'web' de mettre √† jour la base de donn√©es
    - echo "üì¶ Application des migrations..."
    - docker compose exec -T web python manage.py migrate --noinput
    
    # 4. Nettoyage des images Docker inutilis√©es (Gain de place)
    - docker image prune -f
    
    # On utilise Docker (qui est root) pour redonner la propri√©t√© des fichiers au Runner.
    # $(id -u):$(id -g) r√©cup√®re l'ID de l'utilisateur actuel (gitlab-runner).
    # - echo "üîß R√©tablissement des droits sur les fichiers..."
    # - docker run --rm -v "$(pwd):/work" alpine chown -R $(id -u):$(id -g) /work

    # - echo "‚úÖ Site en ligne et dossier propre !"
  after_script:
    - echo "üîß Nettoyage et correction des permissions (Toujours ex√©cut√©)..."
    - docker run --rm -v "$PWD:/work" alpine chown -R $(id -u):$(id -g) /work

# --- JOB 2 : MIROIR VERS GITHUB ---
sync_github:
  stage: sync
  variables:
    GITHUB_ORG: "kpihx-labs"
    REPO_NAME: "kpihx-labs"
  only:
    - main
  script:
    - echo "üîç V√©rification/Cr√©ation du repo sur GitHub..."
    - |
      curl -H "Authorization: token ${GITHUB_TOKEN}" \
           -X POST \
           -d "{\"name\":\"${REPO_NAME}\", \"private\":false}" \
           https://api.github.com/orgs/${GITHUB_ORG}/repos || true
    
    - echo "üîÑ Synchronisation..."
    
    # Push du code
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_ORG}/${REPO_NAME}.git || git remote set-url github https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_ORG}/${REPO_NAME}.git
    - git push github $CI_COMMIT_SHA:refs/heads/main --force